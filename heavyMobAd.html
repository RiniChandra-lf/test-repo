<!doctype html>
<meta charset="utf-8" />
<title>HAI Test — Your Creative + Reliable Bytes</title>
<style>
  body{font:14px system-ui;margin:20px;line-height:1.4}
  iframe{border:1px solid #aaa;width:300px;height:600px;display:block;margin-top:12px}
  label{display:block;margin:8px 0}
</style>

<h2>Heavy Ad Intervention (HAI) test</h2>
<ol>
  <li>Open DevTools → Network: <b>Slow 4G</b>, check <b>Disable cache</b>.</li>
  <li>DevTools → Performance: <b>20× CPU slowdown</b>.</li>
  <li>Reload this page and wait ~5–15s. Check DevTools → <b>Issues</b> and Console.</li>
</ol>

<label><input type="checkbox" id="cpuBurn" checked> Add CPU stress inside the ad</label>
<label><input type="checkbox" id="netLoad" checked> Add large video & images (>30MB)</label>

<iframe id="adframe"></iframe>

<script>
const adframe = document.getElementById('adframe');

function writeAd(cpuOn, netOn){
  const doc = adframe.contentWindow.document;
  doc.open();
  doc.write(`<!doctype html><html><head><meta charset="utf-8"></head><body>

  <!-- Observe interventions (incl heavy-ad) -->
  <script>
    try{
      const ro = new ReportingObserver((reports)=>{ reports.forEach(r=>console.log('[Intervention]', r.type, r.body)); }, {types:['intervention'], buffered:true});
      ro.observe();
    }catch(e){}
  <\/script>

  <!-- Force ad classification before heavy loads -->
  <script src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"><\/script>

  <!-- ===== Your creative (unchanged) ===== -->
  <script>
    window.ndClickThru = "https://photos3.walmart.com/category/1029-christmas--holiday-cards?size=4x8|5x7&povid=Photos3_megamenu_cards_other_christmas&_sort=featured&veh=dsp&adid=Gallery_HIVideo_Cards_Holiday25";
    window.ndTagId = "ntag-1c690bc3-e078-4733-8761-02850bc8903b";
    window.ndSize = [300,600];
    window.metaData = "";
    window.mediaFit = "fit";
  <\/script>
  <script src="https://cdn.90d.io/js/player.js?cb=test"><\/script>
  <script>
  (function(){
    var tries=0, max=300; // 30s @100ms
    var interval = setInterval(function(){
      if(window.RenderStory){
        clearInterval(interval);
        new window.RenderStory({ fetchedTagType: "landing", tagUuid: window.ndTagId }).render();
      }else if(++tries>=max){ clearInterval(interval); }
    },100);
  })();
  <\/script>
  <!-- ===== End creative ===== -->

  ${netOn ? `
    <!-- Reliable network bytes: big MP4 + big JPEGs (offscreen) -->
    <video preload="auto" muted playsinline style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px"
           src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4?r=${Math.random()}"></video>

    <img decoding="async" loading="eager"
         src="https://picsum.photos/4000/4000?random=${Math.random()}"
         style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;" />

    <img decoding="async" loading="eager"
         src="https://picsum.photos/4500/4500?random=${Math.random()}"
         style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;" />

    <script>console.log('Network payload requested: big video + large images');<\/script>
  ` : ''}

  ${cpuOn ? `
    <!-- CPU burn in timed chunks (not rAF) -->
    <script>
      (function burn(totalMs){
        function chunk(){
          const end = performance.now() + 250;
          while(performance.now() < end){}
          totalMs -= 250;
          if(totalMs > 0) setTimeout(chunk, 0);
        }
        chunk();
      })(75000); // target >60s total CPU on throttled devices
    <\/script>
  ` : ''}

  </body></html>`);
  doc.close();
}

function loadAd(){
  writeAd(
    document.getElementById('cpuBurn').checked,
    document.getElementById('netLoad').checked
  );
}

document.getElementById('cpuBurn').addEventListener('change', loadAd);
document.getElementById('netLoad').addEventListener('change', loadAd);
loadAd();
</script>
